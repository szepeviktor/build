#!/usr/bin/env bash

set -e

if [ ! -d bin ]; then
    echo "This script must be run from the project root."
    exit 1
elif [ ! ${WP_DEVELOP_REPO} ]; then
    echo "No git path provided for WP_DEVELOP_REPO."
    exit 1
elif [ ! ${WP_PHPUNIT_REPO} ]; then
    echo "No git path provided for WP_PHPUNIT_REPO."
    exit 1
fi

git config user.name --global ${GIT_NAME}
git config user.email --global ${GIT_EMAIL}

function sync_repo() {
    git remote rm origin
    git remote add origin ${1}
    git remote -v
    git fetch origin --tags
    git checkout master --force
    git branch -u origin/master
    git pull origin master
}

if [ ! -d repos/wordpress ]; then
    echo "Cloning ${WP_DEVELOP_REPO} ..."
    git clone ${WP_DEVELOP_REPO} repos/wordpress
else
    echo "Repository exists, synchronizing with origin..."
    (
        cd repos/wordpress
        sync_repo ${WP_DEVELOP_REPO}
    )
fi

if [ ! -d repos/package ]; then
    echo "Cloning ${WP_PHPUNIT_REPO} ..."
    git clone ${WP_PHPUNIT_REPO} repos/package
    git --git-dir=repos/package/.git config core.autocrlf false 
else
    echo "Repository exists, synchronizing with origin..."
    (
        cd repos/package
        sync_repo ${WP_PHPUNIT_REPO}
    )
fi

php src/build.php
